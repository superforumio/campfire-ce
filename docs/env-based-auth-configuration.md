# ENV-Based Authentication Configuration

## Summary

Authentication method is now configured via environment variables instead of the admin UI toggle. This eliminates edge cases caused by runtime switching between password and OTP auth methods.

## Environment Variables

### AUTH_METHOD

Controls how users authenticate after initial setup.

```bash
AUTH_METHOD=password  # Default: email + password login
AUTH_METHOD=otp       # Passwordless: email + one-time code
```

**Priority order:**
1. `ENV["AUTH_METHOD"]` (if set)
2. Database `accounts.auth_method` column (for backwards compatibility)
3. Default: `"password"`

### AutoBootstrap Variables

For headless/automated deployments, set these to create an admin account on first startup:

```bash
AUTO_BOOTSTRAP=true
ADMIN_EMAIL=admin@example.com
ADMIN_NAME=Administrator  # Optional, defaults to "Administrator"
```

Plus ONE of these for first login:

| Variable | Use Case | First Login Flow |
|----------|----------|------------------|
| `ADMIN_PASSWORD` | Kamal/self-hosted | Password → Forced change |
| `ADMIN_AUTH_TOKEN` | Campfire Cloud | One-time login link (24h expiry) |

## Deployment Scenarios

### Campfire Cloud

```bash
AUTO_BOOTSTRAP=true
ADMIN_EMAIL=user@example.com
ADMIN_AUTH_TOKEN=abc123xyz...  # Generated by Cloud
AUTH_METHOD=otp
```

Flow:
1. Cloud generates `ADMIN_AUTH_TOKEN` and deploys
2. Cloud sends welcome email with login link
3. Admin clicks link → logged in immediately
4. Subsequent logins use OTP (email code)

### Kamal / Self-Hosted

```bash
AUTO_BOOTSTRAP=true
ADMIN_EMAIL=admin@example.com
ADMIN_PASSWORD=temp-password-123
AUTH_METHOD=password  # Or omit for default
```

Flow:
1. Admin signs in with temp password
2. Forced to change password before accessing app
3. Subsequent logins use password

### Manual Setup (No AutoBootstrap)

```bash
AUTH_METHOD=password  # Or "otp"
```

Flow:
1. First visitor sees setup form
2. Creates admin account manually
3. Auth method determined by `AUTH_METHOD` ENV

## Migration from UI Toggle

### Existing Installs

- **No breaking changes** - `AUTH_METHOD` defaults to `"password"`
- Existing `auth_method` database value is respected if ENV not set
- Admin toggle removed from UI, but setting persists in database
- Self-hosters can still change via database if needed:
  ```ruby
  Account.first.update!(auth_method: "otp")
  ```

### Campfire Cloud Existing Servers

- Existing servers continue working (have `ADMIN_PASSWORD`)
- New deploys get `ADMIN_AUTH_TOKEN`
- No migration needed for already-authenticated users

## Technical Details

### Account Model

```ruby
# app/models/account.rb
def auth_method_value
  ENV["AUTH_METHOD"] || auth_method || "password"
end
```

### FirstRun AutoBootstrap

```ruby
# app/models/first_run.rb
def self.auto_bootstrap_enabled?
  ENV["AUTO_BOOTSTRAP"] == "true" &&
    ENV["ADMIN_EMAIL"].present? &&
    (ENV["ADMIN_PASSWORD"].present? || ENV["ADMIN_AUTH_TOKEN"].present?)
end
```

When `ADMIN_AUTH_TOKEN` is set:
- Creates user with random password (never used)
- Creates `AuthToken` record with 24-hour expiry
- User clicks login link to authenticate

When `ADMIN_PASSWORD` is set:
- Creates user with temp password
- Sets `must_change_password: true`
- User must change password on first login

## Files Modified

| File | Change |
|------|--------|
| `app/models/account.rb` | ENV priority for `auth_method_value` |
| `app/models/first_run.rb` | Support `ADMIN_AUTH_TOKEN` |
| `app/views/accounts/_admin_settings.html.erb` | Removed auth_method toggle |
| `app/controllers/accounts_controller.rb` | Removed auth_method from params |
| `.env.sample` | Documented AUTH_METHOD and AutoBootstrap vars |

## Related Documentation

- [Authentication Comparison](./authentication-comparison.md) - Detailed comparison of password vs OTP
- [Password Auth Implementation](./password-auth-implementation.md) - Password flow details
