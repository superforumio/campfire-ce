#!/bin/bash
set -e

# Release script for Campfire CE
# Usage: ./script/release <version> <title>
# Example: ./script/release 1.2.0 "Bug fixes and improvements"

VERSION=$1
TITLE=$2

if [ -z "$VERSION" ] || [ -z "$TITLE" ]; then
  echo "Usage: ./script/release <version> <title>"
  echo "Example: ./script/release 1.2.0 \"Bug fixes and improvements\""
  exit 1
fi

# Ensure we're on master and up to date
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "master" ]; then
  echo "âš ï¸  Warning: You're not on master branch (currently on $CURRENT_BRANCH)"
  read -p "Continue anyway? (y/n) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

TAG="v$VERSION"

echo "ğŸš€ Creating Release $TAG - $TITLE"
echo ""

# Check if tag already exists
if git rev-parse "$TAG" >/dev/null 2>&1; then
  echo "âŒ Tag $TAG already exists!"
  exit 1
fi

# Get commit info for release notes
COMMITS=$(git log --oneline --no-merges $(git describe --tags --abbrev=0 2>/dev/null || echo "")..HEAD 2>/dev/null || git log --oneline --no-merges -10)

# 1. Create and push git tag
echo "ğŸ“Œ Creating and pushing git tag..."
git tag -a "$TAG" -m "$TITLE"
git push origin "$TAG"
echo "âœ… Git tag pushed"
echo ""

# 2. Create GitHub release
echo "ğŸ“ Creating GitHub release..."
gh release create "$TAG" \
  --title "$TAG - $TITLE" \
  --notes "$(cat <<EOF
## $TITLE

### What's Changed
$COMMITS

### Docker Deployment
\`\`\`bash
docker pull ghcr.io/ashwin47/campfire-ce:$TAG
docker restart campfire-web
\`\`\`

### Architecture
\`\`\`
Internet â†’ Caddy (SSL, HTTP/2, ports 80/443) â†’ Puma (port 3000)
\`\`\`

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
echo "âœ… GitHub release created"
echo ""

echo "ğŸ‰ Release $TAG complete!"
echo ""
echo "View release: https://github.com/ashwin47/campfire-ce/releases/tag/$TAG"
echo ""
echo "â³ GitHub Actions will automatically build and push Docker images:"
echo "   - ghcr.io/ashwin47/campfire-ce:$TAG"
echo "   - ghcr.io/ashwin47/campfire-ce:latest"
echo ""
echo "Monitor build: https://github.com/ashwin47/campfire-ce/actions"
