service: campfire

image: superforumio/campfire-ce

servers:
  web:
    hosts:
      - <%= ENV.fetch("SERVER_IP") %>
    options:
      # Network alias for anycable-go to reach Rails RPC endpoint
      network-alias: campfire-web

proxy:
  ssl: true
  host: <%= ENV.fetch("PROXY_HOST") %>
  app_port: 3000

registry:
  server: ghcr.io
  username: superforumio
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  arch: amd64

env:
  clear:
    RAILS_ENV: "production"

  secret:
    - APP_VERSION
    - LAST_DEPLOY
    - SECRET_KEY_BASE
    - VAPID_PUBLIC_KEY
    - VAPID_PRIVATE_KEY
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
    - AWS_DEFAULT_REGION
    - RESEND_API_KEY
    - GUMROAD_ACCESS_TOKEN
    - GUMROAD_ON
    - GUMROAD_PRODUCT_IDS
    - WEBHOOK_SECRET
    - COOKIE_DOMAIN
    - APP_NAME
    - APP_SHORT_NAME
    - APP_DESCRIPTION
    - APP_HOST
    - SUPPORT_EMAIL
    - MAILER_FROM_NAME
    - MAILER_FROM_EMAIL
    - THEME_COLOR
    - BACKGROUND_COLOR
    - ANALYTICS_DOMAIN
    - CSP_FRAME_ANCESTORS
    - ANYCABLE_SECRET

volumes:
  - "/disk/campfire/:/rails/storage/"

# AnyCable WebSocket server
# Requires DNS: ws.<your-domain> pointing to SERVER_IP
accessories:
  anycable:
    image: anycable/anycable-go:1.6
    host: <%= ENV.fetch("SERVER_IP") %>
    proxy:
      host: <%= ENV.fetch("WEBSOCKET_HOST", "ws.#{ENV.fetch('PROXY_HOST')}") %>
      ssl: true
      app_port: 8080
      healthcheck:
        path: /health
    env:
      clear:
        ANYCABLE_HOST: "0.0.0.0"
        ANYCABLE_PORT: "8080"
        ANYCABLE_RPC_HOST: "http://campfire-web:3000/_anycable"
        ANYCABLE_BROADCAST_ADAPTER: "http"
        ANYCABLE_HTTP_BROADCAST_PORT: "8080"
        ANYCABLE_LOG_LEVEL: "info"
      secret:
        - ANYCABLE_SECRET

aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole"
