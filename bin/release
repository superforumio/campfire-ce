#!/usr/bin/env ruby
#
# Creates a GitHub release, which triggers the CI workflow to build
# and push Docker images to GHCR.
#
# Usage: bin/release [version]
#

def get_latest_version
  tags = `git tag --list 'v*' | sort -V`.strip.split("\n")
  return nil if tags.empty?
  tags.last.sub(/^v/, "")
end

def parse_version(version)
  parts = version.split(".").map(&:to_i)
  { major: parts[0] || 0, minor: parts[1] || 0, patch: parts[2] || 0 }
end

def format_version(v)
  "#{v[:major]}.#{v[:minor]}.#{v[:patch]}"
end

def bump(version, type)
  v = parse_version(version)
  case type
  when :major
    v[:major] += 1
    v[:minor] = 0
    v[:patch] = 0
  when :minor
    v[:minor] += 1
    v[:patch] = 0
  when :patch
    v[:patch] += 1
  end
  format_version(v)
end

# Get version from arg or prompt
version = ARGV[0]

if version.nil?
  latest = get_latest_version

  if latest
    puts "\e[1;36mCurrent version: v#{latest}\e[0m"
    puts ""
    puts "  1) \e[1;32mpatch\e[0m  → v#{bump(latest, :patch)}  (bug fixes)"
    puts "  2) \e[1;33mminor\e[0m  → v#{bump(latest, :minor)}  (new features)"
    puts "  3) \e[1;31mmajor\e[0m  → v#{bump(latest, :major)}  (breaking changes)"
    puts "  4) custom"
    puts "  q) quit"
    puts ""
    print "Select version bump [1-4, q]: "

    choice = $stdin.gets.strip.downcase

    case choice
    when "1", "patch"
      version = bump(latest, :patch)
    when "2", "minor"
      version = bump(latest, :minor)
    when "3", "major"
      version = bump(latest, :major)
    when "4", "custom"
      print "Enter version (e.g., 1.2.3): "
      version = $stdin.gets.strip
    when "q", "quit", "exit"
      puts "Release cancelled."
      exit 0
    else
      abort "Invalid choice"
    end
  else
    puts "\e[1;33mNo existing releases found.\e[0m"
    print "Enter initial version (e.g., 1.0.0): "
    version = $stdin.gets.strip
  end
end

abort "Version cannot be empty" if version.nil? || version.strip.empty?
version = version.sub(/^v/, "") # Remove v prefix if provided

current_branch = `git rev-parse --abbrev-ref HEAD`.strip
if current_branch != "main"
  print "\e[1;33mWarning: You are on branch '#{current_branch}', not 'main'. Continue? [y/N] \e[0m"
  abort "Release aborted." unless $stdin.gets.strip.downcase.chars.first == "y"
end

unless `git status --porcelain`.strip.empty?
  print "\e[1;33mWarning: You have uncommitted changes. Continue? [y/N] \e[0m"
  abort "Release aborted." unless $stdin.gets.strip.downcase.chars.first == "y"
end

# Check for unpushed commits
unpushed = `git log @{u}.. --oneline 2>/dev/null`.strip
unless unpushed.empty?
  puts "\e[1;33mWarning: You have unpushed commits:\e[0m"
  unpushed.lines.each { |line| puts "  #{line}" }
  print "\e[1;33mPush now? [Y/n] \e[0m"
  response = $stdin.gets.strip.downcase
  if response.empty? || response.chars.first == "y"
    unless system "git", "push"
      abort "Failed to push. Please push manually and try again."
    end
  else
    print "\e[1;33mRelease with unpushed commits? [y/N] \e[0m"
    abort "Release aborted." unless $stdin.gets.strip.downcase.chars.first == "y"
  end
end

puts "\n\e[1;36mCreating GitHub release v#{version}...\e[0m"

unless system "gh", "release", "create", "v#{version}", "--title", "v#{version}", "--generate-notes"
  abort "Failed to create release; check that the version doesn't already exist"
end

puts "\n\e[1;32m✓ Release v#{version} created!\e[0m"
puts "\e[0;36mGitHub Actions will now build and push the Docker image.\e[0m"
puts "  → https://github.com/superforumio/campfire-ce/actions"
