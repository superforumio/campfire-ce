#!/usr/bin/env ruby
#
# Load testing script for Campfire WebSocket performance
#
# Usage:
#   bin/load [options]
#
# Examples:
#   # Test Action Cable locally (1000 users)
#   bin/load
#
#   # Test Action Cable on remote server
#   bin/load -h server.example.com -u 500
#
#   # Test AnyCable on remote server
#   bin/load -h server.example.com -u 500 --anycable
#
#   # Skip setup (reuse existing containers)
#   bin/load -h server.example.com -u 500 -S
#
# Options:
#   -u, --users USERS      Number of concurrent users (default: 1000)
#   -h, --host HOST        Server to run on (default: localhost)
#   -p, --port PORT        Application port (default: 80 remote, 3000 local)
#   -i, --image IMAGE      Docker image to use
#   -a, --anycable         Use AnyCable mode (runs anycable-go container)
#   -S, --skip-setup       Skip Docker setup (pull images, upload files)
#   --ssh-user USER        SSH user for remote hosts (default: ubuntu)
#
require "bundler/inline"

gemfile do
  source "https://rubygems.org"
  gem "base64"
  gem "bcrypt_pbkdf"
  gem "ed25519"
  gem "sshkit"
end

require "optparse"
require "net/http"
require "uri"

class Load
  include SSHKit::DSL

  attr_reader :users, :setup, :host, :port, :ssh_user
  attr_reader :campfire_image, :anycable

  def initialize(users: 1000, setup: true, host: "localhost", port: nil, ssh_user: "ubuntu", image: nil, anycable: false)
    @users = users
    @setup = setup
    @host = host
    @ssh_user = ssh_user
    @anycable = anycable
    @port = port || (remote? ? 80 : 3000)
    @campfire_image = image || (anycable ? "ghcr.io/superforumio/campfire-ce:anycable" : "ghcr.io/superforumio/campfire-ce:latest")
  end

  def anycable?
    @anycable
  end

  def setup?
    @setup
  end

  def run
    configure_sshkit
    run_setup if setup?
    start_app
    run_test
    output_results
    cleanup
  end

  def remote?
    ![ "localhost", "127.0.0.1" ].include?(host)
  end

  def ssh_host
    remote? ? host : :local
  end

  def k6_dir
    remote? ? "$PWD" : "$PWD/test/performance"
  end

  private
    def configure_sshkit
      SSHKit::Backend::Netssh.configure do |ssh|
        ssh.connection_timeout = 30
        ssh.ssh_options = { user: ssh_user }
      end
    end

    def run_setup
      puts "Running setup..."
      load = self

      on(ssh_host) do |host|
        unless execute(:docker, "-v", raise_on_non_zero_exit: false)
          execute :curl, "-fsSL", "https://get.docker.com", "|", :sh
        end
        execute :docker, :pull, load.campfire_image
        execute :docker, :pull, "anycable/anycable-go:1.6" if load.anycable?
        unless host.local?
          upload! "test/performance/chatter.js", "chatter.js"
          upload! "test/performance/cookies.txt", "cookies.txt"
        end
      end
    end

    def start_app
      puts "Starting app on #{host}#{anycable? ? ' (AnyCable mode)' : ''}..."
      load = self

      on(ssh_host) do
        execute :docker, :rm, "-f", :campfire_load, :campfire_anycable, raise_on_non_zero_exit: false
        execute :docker, :network, :rm, :campfire_net, raise_on_non_zero_exit: false

        if load.anycable?
          # Create network for container communication
          execute :docker, :network, :create, :campfire_net

          # Start Rails app (internal only, anycable-go will proxy)
          execute :docker, :run, "-d", "--rm",
            "--name", :campfire_load,
            "--network", :campfire_net,
            "--network-alias", :web,
            "-e", "SECRET_KEY_BASE=dummy",
            "-e", "RAILS_ENV=performance",
            "-e", "CABLE_ADAPTER=any_cable",
            "-e", "ANYCABLE_SECRET=test-secret",
            load.campfire_image

          # Start anycable-go (exposed to host)
          execute :docker, :run, "-d", "--rm",
            "--name", :campfire_anycable,
            "--network", :campfire_net,
            "--network-alias", :anycable,
            "-p", "#{load.port}:8080",
            "-e", "ANYCABLE_HOST=0.0.0.0",
            "-e", "ANYCABLE_PORT=8080",
            "-e", "ANYCABLE_RPC_HOST=http://web:3000/_anycable",
            "-e", "ANYCABLE_BROADCAST_ADAPTER=http",
            "-e", "ANYCABLE_HTTP_BROADCAST_PORT=8080",
            "-e", "ANYCABLE_SECRET=test-secret",
            "-e", "ANYCABLE_LOG_LEVEL=info",
            "anycable/anycable-go:1.6"
        else
          execute :docker, :run, "-d", "--rm", "--name", :campfire_load, "-p", "#{load.port}:80", "-e", "SECRET_KEY_BASE=dummy", "-e", "RAILS_ENV=performance", load.campfire_image
        end
      end

      wait_for_app_to_start
    end

    def wait_for_app_to_start
      timeout_at = Time.now + 60
      # For AnyCable, check health endpoint; for Action Cable, check root
      path = anycable? ? "/health" : "/"
      uri = URI("http://#{host}:#{port}#{path}")
      loop do
        sleep 1
        puts "Waiting for app to start..."
        raise "App not started after 60 seconds" if Time.now > timeout_at
        break if Net::HTTP.get_response(uri).code.to_i < 400
        sleep 1
      rescue Errno::ECONNREFUSED, Errno::ECONNRESET, EOFError
      end
    end

    def run_test
      puts "Running load test..."
      load = self

      on(ssh_host) do |host|
        execute :docker, :rm, "-f", :k6, raise_on_non_zero_exit: false
        execute :docker, :run, "--name", :k6, "-u \"$(id -u):$(id -g)\"", "-e HOST=#{load.host}", "-e PORT=#{load.port}", "-e USERS=#{load.users}", "-v", "#{load.k6_dir}:/src", "grafana/k6", :run, "/src/chatter.js"
        if host.local?
          execute :docker, :logs, :k6, "2>", "tmp/k6.log"
        else
          execute :docker, :logs, :k6, "2>", "k6.log"
          download! "k6.log", "tmp/k6.log"
        end
      end
    end

    def output_results
      puts "Outputting results..."
      on(:local) do
        puts "Connections/s"
        puts "-------------"
        puts capture(:cat, "tmp/k6.log", "|", "grep 'Subscription confirmed' | awk '{print $1}' | sort| uniq -c | sed '1d; $d' | awk '{sum += $1; count += 1; max = (max > $1) ? max : $1} END {print \"Average:\",sum/count/6,\"Max:\",max/6}'")
        puts
        puts "Messages/s"
        puts "--------------"
        puts capture(:cat, "tmp/k6.log", "|", "grep 'Message received' | awk '{print $1}' | sort | uniq -c | sed '1d; $d' | awk '{sum += $1; count += 1; max = (max > $1) ? max : $1} END {print \"Average:\",sum/count,\"Max:\",max}'")
      end
    end

    def cleanup
      load = self
      on(ssh_host) do |host|
        execute :docker, :rm, "-f", :campfire_load, :campfire_anycable, :k6, raise_on_non_zero_exit: false
        execute :docker, :network, :rm, :campfire_net, raise_on_non_zero_exit: false if load.anycable?
      end
    end
end

options = {}

OptionParser.new do |opts|
  opts.banner = "Usage: #{$0} [options]"

  opts.on("-u", "--users USERS", "User count") do |value|
    options[:users] = value&.to_i
  end

  opts.on("-S", "--skip-setup", "Skip setup") do
    options[:setup] = false
  end

  opts.on("-h", "--host host", "Host to run the app on") do |host|
    options[:host] = host
  end

  opts.on("--ssh-user ssh_user", "User to ssh to remote hosts") do |ssh_user|
    options[:ssh_user] = ssh_user
  end

  opts.on("-p", "--port PORT", "Application port") do |port|
    options[:port] = port
  end

  opts.on("-i", "--image IMAGE", "Docker image to use") do |image|
    options[:image] = image
  end

  opts.on("-a", "--anycable", "Run with AnyCable (uses anycable-go container)") do
    options[:anycable] = true
  end

  opts.on("--help", "Prints this message") do
    puts opts
    exit 0
  end
end.parse!

Load.new(**options).run
