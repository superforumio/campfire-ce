# Plan: Implement User Ban Feature (from basecamp/once-campfire#111)

## Overview
Add a complete user ban system that allows administrators to ban users, which:
- Logs them out immediately
- Deletes all their messages
- Blocks their IP addresses from posting
- Provides UI to ban/unban users

---

## Current Implementation (campfire-ce)

Our codebase uses **two separate columns** for user state:

### Database Schema
```ruby
# users table
active: boolean (default: true)      # false = deactivated/deleted account
suspended_at: datetime (nullable)    # non-null = suspended by admin
```

### User States
| State | `active` | `suspended_at` | Description |
|-------|----------|----------------|-------------|
| Active | `true` | `nil` | Normal user |
| Suspended | `true` | `timestamp` | Admin suspended (can't login, excluded from stats) |
| Deactivated | `false` | `nil` | User deleted their account |

### Current Code Patterns
```ruby
# Scopes
scope :active, -> { where(active: true) }
scope :non_suspended, -> { where(suspended_at: nil) }

# Common query pattern (used ~30 times in StatsService)
User.active.non_suspended
# or
.where("users.active = true AND users.suspended_at IS NULL")

# Methods
user.suspended?      # suspended_at.present?
user.suspend!        # update!(suspended_at: Time.current)
user.unsuspend!      # update!(suspended_at: nil)
user.deactivate      # update!(active: false, ...)
user.deactivated?    # !active?
```

### Membership Handling (Soft-Delete Pattern)
```ruby
# Memberships are SOFT-DELETED (marked inactive, not removed)
has_many :memberships, -> { active }, class_name: "Membership"

def deactivate
  memberships.without_direct_rooms.update!(active: false)  # Soft-delete
  # ...
end

def reactivate
  memberships.without_direct_rooms.update!(active: true)   # Restore
  # ...
end
```

### Gumroad Integration
- `Gumroad::ProcessRefundJob` calls `user.suspend!` on full refund
- `Gumroad::ImportUserJob` sets `suspended_at: nil` on valid purchase

---

## once-campfire Implementation (PR #111)

Upstream uses a **single `status` enum** column:

### Database Schema
```ruby
# users table
status: integer (default: 0)  # enum: 0=active, 1=deactivated, 2=banned
# No 'active' column
# No 'suspended_at' column
```

### User States
| State | `status` | Description |
|-------|----------|-------------|
| Active | `0` | Normal user |
| Deactivated | `1` | User deleted their account |
| Banned | `2` | Admin banned (logged out, IP blocked, content deleted) |

### New Code Patterns
```ruby
# Enum
enum :status, %i[active deactivated banned], default: :active

# Scopes (auto-generated by enum)
User.active       # where(status: 0)
User.deactivated  # where(status: 1)
User.banned       # where(status: 2)

# Methods (auto-generated by enum)
user.active?      # status == 'active'
user.deactivated? # status == 'deactivated'
user.banned?      # status == 'banned'
user.active!      # update!(status: :active)
user.banned!      # update!(status: :banned)
```

### Membership Handling (Hard-Delete Pattern)
```ruby
# Memberships are HARD-DELETED (permanently removed)
has_many :memberships, dependent: :delete_all

def deactivate
  memberships.without_direct_rooms.delete_all  # Hard-delete
  # ...
end

# No reactivate method - memberships are gone
```

### Ban Feature Components
1. **`Ban` model** - Stores banned IP addresses per user
2. **`User::Bannable` concern** - `ban`/`unban` methods
3. **`BlockBannedRequests` concern** - Blocks POST/PUT/DELETE from banned IPs
4. **`RemoveBannedContentJob`** - Deletes all messages asynchronously
5. **Admin UI** - Ban/unban buttons on user profile

---

## Key Differences

| Aspect | campfire-ce | once-campfire |
|--------|-------------|---------------|
| User state storage | 2 columns (`active`, `suspended_at`) | 1 column (`status` enum) |
| Suspended state | `suspended_at` timestamp | N/A (no suspend, only ban) |
| Ban feature | None | Full (IP block, content deletion) |
| Deactivation | `active: false` | `status: :deactivated` |
| Query pattern | `active.non_suspended` | `active` |
| Membership deletion | Soft-delete (`active: false`) | Hard-delete (`delete_all`) |
| User reactivation | Supported (memberships restored) | Not supported (memberships gone) |

---

## Migration Strategy

**Option A: Full migration to `status` enum** (matches upstream)
- Pros: Clean, matches upstream, easier future merges
- Cons: High risk, many file changes (~40+ references)

**Option B: Add ban feature alongside existing columns** (hybrid)
- Pros: Lower risk, fewer changes, keeps Gumroad suspend logic
- Cons: Diverges from upstream, more complex user states

**Recommendation: Option A** - Migrate fully to match upstream for long-term maintainability.

**Important**: Keep campfire-ce's soft-delete pattern for memberships (don't change to hard-delete) because:
1. Allows user reactivation with memberships restored
2. Preserves room history even for deactivated users
3. Different design philosophy that serves our use case

---

## Implementation Steps

### Phase 1: Database Migration

1. **Create `bans` table migration**
   - `user_id` (references)
   - `ip_address` (string, indexed)
   - timestamps

2. **Migrate `users` table from `active`/`suspended_at` to `status` enum**
   - Add `status` integer column (0=active, 1=deactivated, 2=banned)
   - Migrate data: `active=false` → `status=1`, `suspended_at IS NOT NULL` → `status=2`
   - Remove `active` and `suspended_at` columns

### Phase 2: Models

3. **Create `Ban` model** (`app/models/ban.rb`)
   - `belongs_to :user`
   - `Ban.banned?(ip_address)` class method
   - Validation: IP must be public (not loopback/private/link-local)

4. **Create `User::Bannable` concern** (`app/models/user/bannable.rb`)
   - `ban` method: creates IP bans from sessions, logs out, queues content removal
   - `unban` method: removes bans, sets status to active
   - `remove_banned_content` method: deletes all user messages

5. **Update `User` model**
   - Include `Bannable` concern
   - Add `enum :status, %i[active deactivated banned], default: :active`
   - Update `deactivate` method to use `status: :deactivated`
   - Update `reactivate` method to use `status: :active`
   - Remove `suspended?`, `suspend!`, `unsuspend!` methods (replaced by ban)
   - Add `has_many :bans, dependent: :destroy`
   - **Keep soft-delete for memberships** (don't change to `delete_all`)

6. **Update `Message::Broadcasts`**
   - Add `broadcast_remove` method for removing messages via Turbo

### Phase 3: Controllers

7. **Create `Users::BansController`** (`app/controllers/users/bans_controller.rb`)
   - `create` action: bans user (admin only)
   - `destroy` action: unbans user (admin only)

8. **Create `BlockBannedRequests` concern** (`app/controllers/concerns/block_banned_requests.rb`)
   - `before_action :reject_banned_ip` for non-GET requests
   - Returns 429 (Too Many Requests) for banned IPs

9. **Update `ApplicationController`**
   - Include `BlockBannedRequests` concern

10. **Update `AccountsController`**
    - Show banned users to admins in user list

11. **Update `MessagesController#destroy`**
    - Use `@message.broadcast_remove` instead of inline broadcast

### Phase 4: Background Jobs

12. **Create `RemoveBannedContentJob`** (`app/jobs/remove_banned_content_job.rb`)
    - Deletes all messages for banned user
    - Broadcasts removal for real-time UI updates

### Phase 5: Views & Assets

13. **Add `cancel.svg` icon** (`app/assets/images/cancel.svg`)

14. **Update `avatars.css`**
    - Add `.banned` styling (opacity, cancel overlay)

15. **Create `_ban_button.html.erb` partial** (`app/views/users/_ban_button.html.erb`)
    - Ban/Unban button with confirmation dialog

16. **Update `users/show.html.erb`**
    - Show ban button for admins
    - Apply `.banned` class for banned users
    - Hide DM button for banned users

17. **Update `accounts/users/_user.html.erb`**
    - Apply `.banned` class
    - Hide admin controls for banned users

### Phase 6: Routes

18. **Update `config/routes.rb`**
    - Add `resource :ban, only: %i[create destroy]` under users

### Phase 7: Update Dependent Code

19. **Update code using old `active`/`suspended_at` patterns**
    - `StatsService` - update queries (replace `suspended_at IS NULL` with status checks)
    - `Authentication` concern - check `banned?` instead of `suspended?`
    - `SessionsController` - update user lookup
    - `MarketingController` - update member count
    - `Gumroad::ImportUserJob` - use status enum
    - `Gumroad::ProcessRefundJob` - use `banned!` instead of `suspend!`
    - Any other files using `non_suspended`, `suspended_at`, etc.

### Phase 8: Tests

20. **Update test fixtures**
    - Add `status: active` to user fixtures
    - Add `auth_method: password` to account fixtures
    - Update `allowed_hosts.rb` to include test hosts (`www.example.com`, `once.campfire.test`)

21. **Fix existing tests**
    - Update `user_test.rb` to check soft-delete behavior (Membership.active.count decreases, not Membership.count)

22. **Create new tests**
    - `test/models/ban_test.rb`
    - `test/controllers/users/bans_controller_test.rb`
    - `test/controllers/concerns/block_banned_requests_test.rb`
    - `test/fixtures/bans.yml`

---

## Files to Create
- `app/models/ban.rb`
- `app/models/user/bannable.rb`
- `app/controllers/users/bans_controller.rb`
- `app/controllers/concerns/block_banned_requests.rb`
- `app/jobs/remove_banned_content_job.rb`
- `app/views/users/_ban_button.html.erb`
- `app/assets/images/cancel.svg`
- `db/migrate/XXXXXX_create_bans.rb`
- `db/migrate/XXXXXX_change_active_to_status_on_users.rb`
- `test/models/ban_test.rb`
- `test/controllers/users/bans_controller_test.rb`
- `test/controllers/concerns/block_banned_requests_test.rb`
- `test/fixtures/bans.yml`

## Files to Modify
- `app/models/user.rb`
- `app/models/message/broadcasts.rb`
- `app/controllers/application_controller.rb`
- `app/controllers/accounts_controller.rb`
- `app/controllers/messages_controller.rb`
- `app/controllers/concerns/authentication.rb`
- `app/controllers/sessions_controller.rb`
- `app/controllers/marketing_controller.rb`
- `app/controllers/users_controller.rb`
- `app/controllers/stats_controller.rb`
- `app/controllers/rooms/stats_controller.rb`
- `app/services/stats_service.rb`
- `app/helpers/rooms_helper.rb`
- `app/jobs/gumroad/import_user_job.rb`
- `app/jobs/gumroad/process_refund_job.rb`
- `app/jobs/unread_mentions_notifier_job.rb`
- `app/views/users/show.html.erb`
- `app/views/accounts/users/_user.html.erb`
- `app/assets/stylesheets/application/avatars.css`
- `config/routes.rb`
- `config/initializers/allowed_hosts.rb`
- `test/fixtures/users.yml`
- `test/fixtures/accounts.yml`
- `test/models/user_test.rb`

---

## Risk Assessment
- **High**: Migration from `active`/`suspended_at` to `status` enum affects many queries (~40+ references)
- **Medium**: Gumroad integration uses `suspended_at` for refund handling (needs update to use `banned!`)
- **Low**: IP banning could affect users behind shared IPs (NAT)

## Rollback Strategy
- Keep migration reversible
- Can revert to `active`/`suspended_at` if needed
