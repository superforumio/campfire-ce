#!/bin/bash -e

# NOTE: AWS backup configuration is disabled by default.
# Campfire Cloud (https://campfirecloud.com) handles backups via CreateFilesBackupJob.
# Uncomment below if you need AWS credentials for S3 storage or self-hosted backups.

# create log directory
mkdir -p /rails/storage/logs

# Prepare databases (creates tables if needed, runs pending migrations)
# This must run BEFORE bin/boot starts parallel processes (web, workers, redis)
# to ensure Solid Queue tables exist before workers try to access them.
./bin/rails db:prepare

# create config directories
mkdir -p ~/.aws
mkdir -p /rails/storage/aws

# set aws creds
echo "[default]" >> ~/.aws/credentials
echo "aws_access_key_id = $AWS_ACCESS_KEY_ID" >> ~/.aws/credentials
echo "aws_secret_access_key = $AWS_SECRET_ACCESS_KEY" >> ~/.aws/credentials

# set aws region
echo "[default]" >> ~/.aws/config
echo "region = us-east-1" >> ~/.aws/config

cp ~/.aws/credentials /rails/storage/aws/credentials
cp ~/.aws/config /rails/storage/aws/config