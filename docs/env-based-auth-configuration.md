# ENV-Based Authentication Configuration

## Summary

Authentication method is now configured via environment variables instead of the admin UI toggle. This eliminates edge cases caused by runtime switching between password and OTP auth methods.

## Authentication Methods

| Method | `AUTH_METHOD=` | Login Flow |
|--------|----------------|------------|
| **Password** | `password` (default) | Email + password |
| **OTP** | `otp` | Email → receive 6-digit code via email → enter code |

**Note:** OTP login sends only a 6-digit code. There is no magic link for regular logins.

## Environment Variables

### AUTH_METHOD

Controls how users authenticate after initial setup.

```bash
AUTH_METHOD=password  # Default: email + password login
AUTH_METHOD=otp       # Passwordless: email + 6-digit code
```

Invalid `AUTH_METHOD` values fall back to `"password"` for safety.

### AutoBootstrap Variables (Campfire Cloud Only)

For Campfire Cloud managed deployments, set these to create an admin account on first startup:

```bash
AUTO_BOOTSTRAP=true
ADMIN_EMAIL=admin@example.com
ADMIN_NAME=Administrator  # Optional, defaults to "Administrator"
ADMIN_AUTH_TOKEN=<32+-char-secure-token>  # One-time login link
```

**Security:** `ADMIN_AUTH_TOKEN` must be at least 32 characters. Use a cryptographically random value.

**For Kamal/self-hosted:** Use the manual first_run flow instead. Do not set `AUTO_BOOTSTRAP`.

## Deployment Scenarios

### Campfire Cloud

```bash
AUTO_BOOTSTRAP=true
ADMIN_EMAIL=user@example.com
ADMIN_AUTH_TOKEN=<random-32+-char-token>  # Generated by Cloud
AUTH_METHOD=otp
```

Flow:
1. Cloud generates `ADMIN_AUTH_TOKEN` (32+ chars) and deploys
2. Cloud sends welcome email with one-time login link
3. Admin clicks link → logged in immediately
4. Subsequent logins use OTP (6-digit code sent via email)

### Kamal / Self-Hosted

```bash
AUTH_METHOD=password  # Or "otp", or omit for default
```

Flow:
1. First visitor sees first_run setup form
2. Creates admin account manually (name, email, password)
3. Admin logged in and can invite others
4. Subsequent logins use the configured auth method

### Manual Setup (No AutoBootstrap)

Same as Kamal/self-hosted. The first visitor completes the setup form.

## Migration Notes

- `AUTH_METHOD` defaults to `"password"` if not set
- The `auth_method` database column has been removed (ENV-only now)
- Admin toggle was removed from UI in a previous release

## Technical Details

### Account Model

```ruby
# app/models/account.rb
VALID_AUTH_METHODS = %w[password otp].freeze

def auth_method_value
  value = ENV["AUTH_METHOD"] || "password"
  value.in?(VALID_AUTH_METHODS) ? value : "password"
end
```

### FirstRun AutoBootstrap

```ruby
# app/models/first_run.rb
def self.auto_bootstrap_enabled?
  ENV["AUTO_BOOTSTRAP"] == "true" &&
    ENV["ADMIN_EMAIL"].present? &&
    ENV["ADMIN_AUTH_TOKEN"].present?
end
```

When `ADMIN_AUTH_TOKEN` is set:
- Token must be at least 32 characters (raises `ArgumentError` otherwise)
- Creates user with random password (never used)
- Creates `AuthToken` record with 24-hour expiry
- User clicks login link to authenticate (one-time only)

## Files Modified

| File | Change |
|------|--------|
| `app/models/account.rb` | ENV priority + validation for `auth_method_value` |
| `app/models/first_run.rb` | AutoBootstrap with `ADMIN_AUTH_TOKEN` (Campfire Cloud) |
| `app/views/accounts/_admin_settings.html.erb` | Removed auth_method toggle |
| `app/controllers/accounts_controller.rb` | Removed auth_method from params |
| `app/views/auth_token_mailer/otp.text.erb` | OTP email with code only (no magic link) |
| `.env.sample` | Documented AUTH_METHOD and AutoBootstrap vars |
